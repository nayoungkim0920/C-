-구성
OpenCV : 4.10.0
CUDA : 12.1 (vs 2017 ~ 2019만 지원)
cuDNN : 9.1
VisualStudion : 2019

-설치하기
1)OpenCV
C:\opencv(sources, build)
C:\opencv_contrib

2) IPP/TBB
C:\Program Files (x86)\Intel\oneAPI

3) cuDNN
C:\Program Files\NVIDIA\CUDNN\v9.1

4) CUDA Toolkit
C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v12.1

5) OpenMP(Visual Studio 20022)
프로젝트속성 > C/C++ > 언어 > OpenMP 지원 > 예

6 )시스템환경변수설정
CUDA_HOME
C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v12.1
CUDA_PATH
C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v12.1
CUDA_PATH_V12_1
C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v12.1
CUDNN_HOME
C:\Program Files\NVIDIA\CUDNN\v9.1\bin\12.4
OpenCV_DIR
C:/opencv/build
OPENCV_ENABLE_TBB
ON
Path
C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v12.1\bin
C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v12.1\libnvvp
C:\Program Files\NVIDIA\CUDNN\v9.1\bin\12.4
C:\opencv\build\bin
C:\opencv\build\x64\vc16\bin
C:\Qt\6.7.1\msvc2019_64\bin
C:\opencv\build
C:\Program Files (x86)\Intel\oneAPI\tbb\2021.12\bin
C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v12.1\bin
TBB_DIR
C:\Program Files (x86)\Intel\oneAPI\tbb\2021.12\bin
TBB_ROOT
C:\Program Files (x86)\Intel\oneAPI\tbb\2021.12\bin

-OpenCV 설정 및 제너레이트(Release/Debug)
1)Release
cmake -DCMAKE_BUILD_TYPE=Release -DOPENCV_EXTRA_MODULES_PATH="C:/opencv_contrib/modules" -DBUILD_opencv_cudaarithm=ON -DWITH_CUDA=ON -DCUDA_TOOLKIT_ROOT_DIR="C:/Program Files/NVIDIA GPU Computing Toolkit/CUDA/v12.1" -DCUDA_ARCH_BIN="7.5" -DCUDNN_LIB_DIR="C:/Program Files/NVIDIA/CUDNN/v9.1/lib/12.4/x64" -DCUDNN_LIBRARY="C:/Program Files/NVIDIA/CUDNN/v9.1/lib/12.4/x64/cudnn.lib" -DCUDNN_INCLUDE_DIR="C:/Program Files/NVIDIA/CUDNN/v9.1/include/12.4" -DOPENCV_DNN_CUDA=ON -DWITH_TBB=ON -DWITH_OPENMP=ON -DWITH_ONETBB=ON C:/opencv/sources
cmake --build . --config Release
2)Debug
cmake -DCMAKE_BUILD_TYPE=Debug -DOPENCV_EXTRA_MODULES_PATH="C:/opencv_contrib/modules" -DBUILD_opencv_cudaarithm=ON -DWITH_CUDA=ON -DCUDA_TOOLKIT_ROOT_DIR="C:/Program Files/NVIDIA GPU Computing Toolkit/CUDA/v12.1" -DCUDA_ARCH_BIN="7.5" -DCUDNN_LIB_DIR="C:/Program Files/NVIDIA/CUDNN/v9.1/lib/12.4/x64" -DCUDNN_LIBRARY="C:/Program Files/NVIDIA/CUDNN/v9.1/lib/12.4/x64/cudnn.lib" -DCUDNN_INCLUDE_DIR="C:/Program Files/NVIDIA/CUDNN/v9.1/include/12.4" -DOPENCV_DNN_CUDA=ON -DWITH_TBB=ON -DWITH_OPENMP=ON -DWITH_ONETBB=ON C:/opencv/sources
cmake --build . --config Debug
cmake -G "Visual Studio 16 2019" -A x64 -DCMAKE_BUILD_TYPE=Debug -DOPENCV_EXTRA_MODULES_PATH="C:/opencv_contrib/modules" -DBUILD_opencv_cudaarithm=ON -DWITH_CUDA=ON -DCUDA_TOOLKIT_ROOT_DIR="C:/Program Files/NVIDIA GPU Computing Toolkit/CUDA/v12.1" -DCUDA_ARCH_BIN="7.5" -DCUDNN_INCLUDE_DIR="C:/Program Files/NVIDIA/CUDNN/v9.1/include/12.4" -DCUDNN_LIBRARY="C:/Program Files/NVIDIA/CUDNN/v9.1/lib/12.4/x64/cudnn.lib" -DOPENCV_DNN_CUDA=ON -DWITH_TBB=ON -DWITH_OPENMP=ON -DWITH_ONETBB=ON -DOPENCV_ENABLE_NONFREE=ON -DBUILD_opencv_world=ON -DCUDA_VERBOSE_BUILD=ON -DBUILD_opencv_cudev=ON -DBUILD_opencv_cudaimgproc=ON -DCUDA_NVCC_FLAGS="-ccbin=cl" C:/opencv/sources

3)Visual Studio 
2022버전으로 cmake, build시 cuda지원불가로 2019버전설치 후 cmake, build
vs_community__f2cf4f3974864621ace5757560120cd1.exe
- 설치시나 visual studio에서 
도구> 도구 및 기능 가져오기 > 개발자용 워크로드 > C++를 사용한 데스크톱 개발 >
MSVC c143 - VS 2022 C++ x64/x86 빌드 도구 등을 체크한 후 설치한다.
(visual studio 종료하고 설치한다.)
- 설정, 생성, 빌드
cmake -G "Visual Studio 16 2019" -A x64 -DCMAKE_BUILD_TYPE=Debug -DOPENCV_EXTRA_MODULES_PATH="C:/opencv_contrib/modules" -DBUILD_opencv_cudaarithm=ON -DWITH_CUDA=ON -DCUDA_TOOLKIT_ROOT_DIR="C:/Program Files/NVIDIA GPU Computing Toolkit/CUDA/v12.1" -DCUDA_ARCH_BIN="7.5" -DCUDNN_LIB_DIR="C:/Program Files/NVIDIA/CUDNN/v9.1/lib/12.4/x64" -DCUDNN_LIBRARY="C:/Program Files/NVIDIA/CUDNN/v9.1/lib/12.4/x64/cudnn.lib" -DCUDNN_INCLUDE_DIR="C:/Program Files/NVIDIA/CUDNN/v9.1/include/12.4" -DOPENCV_DNN_CUDA=ON -DWITH_TBB=ON -DWITH_OPENMP=ON -DWITH_ONETBB=ON C:/opencv/sources
cmake --build . --config Debug
cmake -G "Visual Studio 16 2019" -A x64 -DCMAKE_BUILD_TYPE=Release -DOPENCV_EXTRA_MODULES_PATH="C:/opencv_contrib/modules" -DBUILD_opencv_cudaarithm=ON -DWITH_CUDA=ON -DCUDA_TOOLKIT_ROOT_DIR="C:/Program Files/NVIDIA GPU Computing Toolkit/CUDA/v12.1" -DCUDA_ARCH_BIN="7.5" -DCUDNN_LIB_DIR="C:/Program Files/NVIDIA/CUDNN/v9.1/lib/12.4/x64" -DCUDNN_LIBRARY="C:/Program Files/NVIDIA/CUDNN/v9.1/lib/12.4/x64/cudnn.lib" -DCUDNN_INCLUDE_DIR="C:/Program Files/NVIDIA/CUDNN/v9.1/include/12.4" -DOPENCV_DNN_CUDA=ON -DWITH_TBB=ON -DWITH_OPENMP=ON -DWITH_ONETBB=ON C:/opencv/sources
cmake --build . --config Release
->시간이 굉장히 오래 걸림
cmake -G "Visual Studio 16 2019" -A x64 -DCMAKE_BUILD_TYPE=Debug -DCMAKE_INSTALL_PREFIX="C:/opencv/build" -DOPENCV_EXTRA_MODULES_PATH="C:/opencv_contrib/modules" -DWITH_CUDA=ON -DCUDA_TOOLKIT_ROOT_DIR="C:/Program Files/NVIDIA GPU Computing Toolkit/CUDA/v12.1" -DCUDA_ARCH_BIN="7.5" -DCUDNN_INCLUDE_DIR="C:/Program Files/NVIDIA/CUDNN/v9.1/include/12.4" -DCUDNN_LIBRARY="C:/Program Files/NVIDIA/CUDNN/v9.1/lib/12.4/x64/cudnn.lib" -DOPENCV_DNN_CUDA=ON -DWITH_TBB=ON -DWITH_OPENMP=ON -DWITH_ONETBB=ON -DOPENCV_ENABLE_NONFREE=ON -DBUILD_opencv_world=ON -DBUILD_opencv_cudev=ON -DBUILD_opencv_cudaimgproc=ON -DCUDA_NVCC_FLAGS="-ccbin=cl" -DCUDA_VERBOSE_BUILD=ON -DCMAKE_VERBOSE_MAKEFILE=ON -DCUDA_TOOLKIT_INCLUDE="C:/Program Files/NVIDIA GPU Computing Toolkit/CUDA/v12.1/include" -DCUDA_CUDART_LIBRARY="C:/Program Files/NVIDIA GPU Computing Toolkit/CUDA/v12.1/lib/x64/cudart.lib" -DCUDA_CUDA_LIBRARY="C:/Program Files/NVIDIA GPU Computing Toolkit/CUDA/v12.1/lib/x64/cuda.lib" -DCMAKE_PREFIX_PATH="C:/Qt/6.7.1/msvc2019_64;C:/opencv/build" C:/opencv/sources


3)CMakeListx.txt
cmake_minimum_required(VERSION 3.14)
project(Project1)

# Qt, OpenCV, CUDA 설정
set(CMAKE_PREFIX_PATH "C:/Qt/6.7.1/msvc2019_64" "C:/opencv/build")
find_package(Qt6 REQUIRED COMPONENTS Widgets Core Gui)
find_package(OpenCV REQUIRED COMPONENTS core imgproc highgui)

# CUDA 설정
set(CUDA_TOOLKIT_ROOT_DIR "C:/Program Files/NVIDIA GPU Computing Toolkit/CUDA/v12.1")
find_package(CUDA 12.1 REQUIRED)

# Intel oneAPI IPP 추가
set(IPP_INCLUDE_DIR "C:/Program Files (x86)/Intel/oneAPI/ipp/2021.11/include")
set(IPP_LIB_DIR "C:/Program Files (x86)/Intel/oneAPI/ipp/2021.11/lib")

# Intel oneAPI TBB 추가
set(TBB_INCLUDE_DIR "C:/Program Files (x86)/Intel/oneAPI/tbb/2021.12/include")
set(TBB_LIB_DIR "C:/Program Files (x86)/Intel/oneAPI/tbb/2021.12/lib")

# 추가 포함 디렉터리 설정
include_directories(
    ${IPP_INCLUDE_DIR}
    ${TBB_INCLUDE_DIR}
    ${CUDA_INCLUDE_DIRS}  # CUDA의 인클루드 디렉토리 추가
    ${OpenCV_INCLUDE_DIRS}  # OpenCV의 인클루드 디렉토리도 추가할 수 있습니다.
    # ${CUDNN_INCLUDE_DIRS}  # 만약 cuDNN을 사용할 경우 인클루드 디렉토리도 추가해야 합니다.
)

# CUDA 파일 설정
set(CUDA_NVCC_FLAGS ${CUDA_NVCC_FLAGS} -std=c++11 --expt-relaxed-constexpr)

# 실행 파일 추가
qt6_wrap_cpp(MOC_FILES
    MainWindow.h
    ImageProcessor.h
)

add_executable(Project1
    main.cpp
    MainWindow.cpp
    MainWindow.h
    MainWindow.ui
    ImageProcessor.cpp
    ImageProcessor.h
    ${MOC_FILES}  # 이전에 생성한 MOC 파일
)

# Qt 및 OpenCV 라이브러리 링크
target_link_libraries(Project1
    Qt6::Widgets
    Qt6::Core
    Qt6::Gui
    ${OpenCV_LIBS}
)

# Intel oneAPI IPP 라이브러리 링크
target_link_libraries(Project1
    "${IPP_LIB_DIR}/ippimt.lib"
    "${IPP_LIB_DIR}/ippvmmt.lib"
    "${IPP_LIB_DIR}/ippsmt.lib"
    "${IPP_LIB_DIR}/ippcoremt.lib"
    "${IPP_LIB_DIR}/ippcore.lib"
    "${IPP_LIB_DIR}/ippi.lib"
    "${IPP_LIB_DIR}/ipps.lib"
    "${IPP_LIB_DIR}/ippcvmt.lib"
)

# Intel oneAPI TBB 라이브러리 링크
target_link_libraries(Project1
    "${TBB_LIB_DIR}/tbb.lib"
    "${TBB_LIB_DIR}/tbbmalloc.lib"
    "${TBB_LIB_DIR}/tbbmalloc_proxy.lib"
)

# CUDA 및 cuDNN 라이브러리 링크
target_link_libraries(Project1
    ${CUDA_LIBRARIES}
    # ${CUDNN_LIBRARIES}  # cuDNN을 사용할 경우 추가합니다.
    ${CUDA_cudart_LIBRARY}
    ${CUDA_cublas_LIBRARY}
    ${CUDA_curand_LIBRARY}
)

# 병렬 처리 백엔드 설정
if(WIN32)
    # ONETBB 설정
    set(OPENCV_ENABLE_ONETBB ON)
    if(OPENCV_ENABLE_ONETBB)
        target_compile_definitions(Project1 PRIVATE CV_ENABLE_ONETBB)
        target_link_libraries(Project1
            #"${IPP_LIB_DIR}/libiomp5md.lib"  # ONETBB를 위한 라이브러리 링크
            "${TBB_LIB_DIR}/tbb.lib"  # ONETBB를 위한 TBB 라이브러리 재사용
        )
    endif()
endif()

# 실행 파일 출력 디렉토리 설정
set_target_properties(Project1 PROPERTIES
    RUNTIME_OUTPUT_DIRECTORY_DEBUG "${CMAKE_BINARY_DIR}/Debug"
    RUNTIME_OUTPUT_DIRECTORY_RELEASE "${CMAKE_BINARY_DIR}/Release"
)

# DLL 복사
# 디버그 빌드에서의 OpenCV opencv_world DLL 복사
add_custom_command(TARGET Project1 POST_BUILD
    COMMAND ${CMAKE_COMMAND} -E copy_if_different
    "C:/opencv/build/x64/vc16/bin/opencv_world4100d.dll" "$<TARGET_FILE_DIR:Project1>"
    COMMENT "Copying OpenCV Debug opencv_world DLL to output directory"
)

# 릴리스 빌드에서의 OpenCV opencv_world DLL 복사
add_custom_command(TARGET Project1 POST_BUILD
    COMMAND ${CMAKE_COMMAND} -E copy_if_different
    "C:/opencv/build/x64/vc16/bin/opencv_world4100.dll" "$<TARGET_FILE_DIR:Project1>"
    COMMENT "Copying OpenCV Release opencv_world DLL to output directory"
)

# 디버그 빌드에서의 OpenCV DLL 복사
add_custom_command(TARGET Project1 POST_BUILD
    COMMAND ${CMAKE_COMMAND} -E copy_if_different
    "C:/opencv/build/bin/Debug/opencv_imgcodecs4100d.dll" "$<TARGET_FILE_DIR:Project1>"
    COMMAND ${CMAKE_COMMAND} -E copy_if_different
    "C:/opencv/build/bin/Debug/opencv_core4100d.dll" "$<TARGET_FILE_DIR:Project1>"
    COMMAND ${CMAKE_COMMAND} -E copy_if_different
    "C:/opencv/build/bin/Debug/opencv_imgproc4100d.dll" "$<TARGET_FILE_DIR:Project1>"
    COMMENT "Copying OpenCV Debug DLLs to output directory"
)

# 릴리스 빌드에서의 OpenCV DLL 복사
add_custom_command(TARGET Project1 POST_BUILD
    COMMAND ${CMAKE_COMMAND} -E copy_if_different
    "C:/opencv/build/bin/Release/opencv_imgcodecs4100.dll" "$<TARGET_FILE_DIR:Project1>"
    COMMAND ${CMAKE_COMMAND} -E copy_if_different
    "C:/opencv/build/bin/Release/opencv_core4100.dll" "$<TARGET_FILE_DIR:Project1>"
    COMMAND ${CMAKE_COMMAND} -E copy_if_different
    "C:/opencv/build/bin/Release/opencv_imgproc4100.dll" "$<TARGET_FILE_DIR:Project1>"
    COMMENT "Copying OpenCV Release DLLs to output directory"
)

# IPP 및 TBB 헤더 파일 포함
target_include_directories(Project1 PRIVATE
    ${IPP_INCLUDE_DIR}
    ${TBB_INCLUDE_DIR}
)

